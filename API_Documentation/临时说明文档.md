# 权益配置与订阅套餐使用说明

本文档解释 user 服务当前的“权益配置/使用量/钱包扣费”机制如何配置与接入业务，并给出“订阅金额、折扣金额”等能力的推荐扩展方案。

## 1. 当前系统的核心概念（现状）

当前 user 服务把“用户属于什么套餐”“套餐对某项资源限制多少”“用户用了多少”“超额如何扣费”拆成四类数据：

1) 用户订阅（用户属于哪个套餐）

- 表：`user_subscriptions`
- 关键字段：`user_id`、`plan_type`（free/pro/enterprise）、`status`、`expires_at`
- 作用：决定当前用户使用哪一套权益规则

2) 权益配置（某套餐对某资源的限制）

- 表：`user_quota_configs`
- 关键字段：`plan_type`、`resource_key`、`limit_value`、`period`、`allow_overage`、`overage_unit_price`
- 作用：定义“这项资源”在该套餐下每周期可使用多少、是否允许超额付费、超额单价是多少

3) 用量记录（用户在当前周期用了多少）

- 表：`user_usages`
- 关键字段：`user_id`、`resource_key`、`usage_count`、`period_start`、`period_end`
- 作用：用于在接口中判断是否超过 `limit_value`

4) 钱包余额与流水（用于超额付费或其它扣费）

- 表：`users.balance`（余额）
- 表：`wallet_transactions`（流水）

5) 账单（用于对账、统计与运营分析）

- 表：`user_bills`
- 关键字段：`user_id`、`bill_type`、`channel`、`gateway`、`amount`、`currency`、`status`、`order_no`、`external_order_no`、`created_at`、`paid_at`
- 作用：提供面向前端/运营的“可查询、可筛选、可统计”的交易数据源（充值、超额扣费等）

配套的主要接口：

- 管理端：创建/查看/删除权益配置
  - `POST /api/user/quotas`
  - `GET /api/user/quotas`
  - `DELETE /api/user/quotas/{config_id}`
- 用户端：查看自己的用量、余额
  - `GET /api/user/usage/my`
  - `GET /api/user/wallet/balance`
- 业务侧：消耗权益（内部调用）
  - `POST /api/user/quota/consume`

代码入口（便于对照）：

- 权益逻辑：`services/user/logic.py` 的 `check_and_consume_quota`
- 权益模型：`services/user/models.py` 的 `UserQuotaConfig`、`UserUsage`、`UserSubscription`
- 账单接口：`GET /api/user/bills/my`、`GET /api/user/admin/bills`

## 2. “权益配置”具体怎么配

### 2.1 resource_key 怎么定

`resource_key` 是“你要限制的资源”的唯一标识。建议按“业务动作 + 计费粒度”设计：

- `ppt_pages`：PPT 导出按页计费/计次
- `pdf_export`：PDF 导出按次
- `deep_insight_report`：深度洞察报告生成按次
- `agent_chat_tokens`：按 token（需要你在业务侧先算出 token，再传 count）

同一个业务动作如果存在不同粒度（例如导出/生成/下载），尽量拆成不同 key，便于配置与统计。

### 2.2 limit_value 怎么配

- `-1`：无限制
- `0`：完全禁止（不建议用 0 表示“未配置”，因为当前逻辑对未配置会直接拒绝）
- `N`：每周期可用 N 次/页/token 等（由 resource_key 决定计量单位）

### 2.3 allow_overage + overage_unit_price 怎么配

当超过 `limit_value` 时：

- `allow_overage=false`：直接拒绝（返回 allowed=false）
- `allow_overage=true`：按 `overage_unit_price * count` 计算费用，若余额足够则扣余额并允许本次消耗

**重要注意（混合计费场景）：**

如果你的业务场景采用了“混合计费”（即配额按页，超额按 Token），那么配置时的 `overage_unit_price` 必须是 **Token 的单价**。

- 示例：PPT 生成，限制 100 页，超额按 0.0001 元/Token 计费。
- 配置：
  - `limit_value`: 100 (代表 100 页)
  - `overage_unit_price`: 0.0001 (代表 1 Token 的价格，不是 1 页的价格！)
  - `remark`: "限制100页，超额按Token计费，单价0.0001/Token" (强烈建议写清楚备注)

### 2.4 period 怎么配（当前实现的限制）

`user_quota_configs.period` 字段在接口中可配置，但当前实现没有根据 period 做分支（daily/monthly 等不会改变周期算法）：

- 当前周期按“自然月账期”计算（从订阅生效日开始按月滚动）
- 当订阅为 active 且未过期时：以订阅到期日 `expires_at` 作为当前周期结束时间（周期开始为 `expires_at` 的上一个自然月同日；如果当月天数不足则取当月最后一天）
- 在其它场景下：周期以订阅更新日 `subscription.updated_at`（没有则退到 created_at）为锚点，从锚点日起按自然月滚动（例如 1 月 31 日 + 1 月 = 2 月 28/29 日）

如果你要严格支持 daily/monthly/annual，建议后续把周期计算改为真正按 `period` 计算，并与订阅账期对齐（见第 5 节建议）。

## 3. 前端怎么用（谁该调用哪个接口）

### 3.1 管理端前端（配置权益）

管理端页面通常需要三类能力。为了降低配置复杂度，建议前端采用**联动表单**设计：

**前端配置表单设计建议：**

1.  **基础信息区**：
    -   **套餐选择**：[下拉框] (Free/Pro/Enterprise)
    -   **资源 Key**：[输入框或下拉框] (如 `chat_model`, `ppt_pages`)
    -   **周期配额**：[数字输入] (如 1000)
    -   **周期类型**：[下拉框] (Monthly/Daily)
    -   **允许超额**：[开关] (True/False)

2.  **超额计费策略区（仅当“允许超额”开启时显示）**：
    -   **计费模式**：[单选框/下拉框]
        -   选项 A：**固定单价 (`unit_price`)** —— 适用于 PPT 页数、PDF 导出等标准品。
        -   选项 B：**外部/模型定价 (`external_pricing`)** —— 适用于 AI 对话、模型生成等动态倍率场景。
    -   **单价设置**（仅当选择“固定单价”时显示）：
        -   **超额单价**：[数字输入] (如 0.5 元/页)
    -   **模型说明**（仅当选择“外部/模型定价”时显示）：
        -   [提示文案]：*“此模式下，实际扣费金额由调用方（如 StratifyAI）根据模型倍率动态计算，此处无需配置单价。”*

3.  **操作区**：
    -   [保存配置] [取消]

---

**API 交互细节：**

1) 列出所有套餐


1) 列出所有套餐

- `GET /api/user/plans`
- 当前计划配置来源：`services/user/plans.json`
- 现状：plans.json 目前只包含 name/description/max_pois，不包含价格

2) 配置某套餐的权益规则（对某个 resource_key 的限制）

- `POST /api/user/quotas`
- 示例请求体：

```json
{
  "plan_type": "pro",
  "resource_key": "ppt_pages",
  "limit_value": 200,
  "period": "monthly",
  "allow_overage": true,
  "overage_unit_price": 0.5,
  "overage_strategy": "unit_price",
  "remark": "运营备注：2026-01-XX 调整 PPT 配额"
}
```

**或者配置模型计费：**

```json
{
  "plan_type": "pro",
  "resource_key": "chat_model",
  "limit_value": 1000,
  "period": "monthly",
  "allow_overage": true,
  "overage_strategy": "external_pricing",
  "remark": "AI对话，超额后使用 StratifyAI 服务的模型定价"
}
```

3) 查看/删除权益规则

- `GET /api/user/quotas`
- `DELETE /api/user/quotas/{config_id}`

### 3.2 普通用户前端（展示使用情况与余额）

普通用户侧建议只展示，不直接发起“消耗权益”的调用：

- 展示已用量/剩余量：`GET /api/user/usage/my`
- 展示余额与充值入口：`GET /api/user/wallet/balance` + `POST /api/user/wallet/recharge`

原因：消耗接口会决定是否允许某项业务动作，属于“服务端强校验”。如果让前端直接调用，容易出现绕过与重放请求问题。

## 4. 业务如何接入权益限制（最关键的一段）

你可以把 `POST /api/user/quota/consume` 理解为“业务动作的闸门”。

典型接入模式：

1) 用户在业务模块点击某动作（例如导出 PDF）
2) 业务服务端在真正执行导出前，先调用 user 服务消耗权益
3) user 服务返回 allowed=true 才继续执行；否则返回前端“权益不足/余额不足/请升级”

### 4.1 业务侧调用 consume 的建议时机

- 需要限制的动作：在“执行重任务/耗资源/产生价值”的入口处调用
- 计量是 count>1 的：尽量在业务侧先算出 count（例如要导出的页数），再一次性 consume，减少边界问题

### 4.2 consume 接口返回值如何处理

`POST /api/user/quota/consume` 返回 `ConsumeResponse`：

- `allowed=true`：允许继续执行业务动作
- `allowed=false`：拒绝，`message` 给出原因
- `cost`：如果走超额付费，返回本次扣费金额（用于前端展示/记账）
- `usage_after`：本次消耗后用量（用于前端刷新展示）

### 4.3 混合计费与预判功能（进阶用法）

为了支持“配额按页扣，超额按 Token 扣”等复杂场景，以及“生成前预判”需求，consume 接口新增了三个关键参数：

1) **混合计费 (`billing_count`)**

   - 场景：AI 生成 PPT，配额限制是“100页”，但超额时想按“实际消耗 Token”扣费。
   - 用法：传入 `count=5` (页) 和 `billing_count=2000` (Token)。
   - 逻辑：
     - 如果配额充足：扣除 5 页配额，费用 0。
     - 如果配额不足（走超额）：
       - 若 `overage_strategy=unit_price`：忽略 `count`，按 `billing_count * overage_unit_price` 计算扣费金额。
       - 此时 `overage_unit_price` 需配置为“Token 单价”。

2) **外部/模型定价 (`external_price`)**

   - 场景：AI 对话，不同模型倍率不同，User 服务无法得知具体倍率。
   - 用法：业务方（StratifyAI）先算出本次请求的总费用（例如 0.05 元），传入 `external_price=0.05`。
   - 逻辑：
     - 如果配额不足（走超额）：
       - 若 `overage_strategy=external_pricing`：直接扣除 `external_price` 指定的金额。

3) **生成前预判 (`check_only`)**

   - 场景：用户点击生成时，先判断有没有钱/配额，如果有再让大模型跑（避免跑完没钱扣）。
   - 用法：传入 `check_only=true`。
   - 逻辑：只进行配额与余额检查，**不修改数据库**（不扣配额、不扣钱）。
   - 返回：`allowed=true` 表示通过预判，可以开始生成。

**推荐的 AI 生成业务流程（以模型定价为例）：**

1. **预判**：
   - 业务方估算 Token 和 预估费用（estimated_price）。
   - 调用 consume (check_only=true, count=0, external_price=estimated_price)。
   - 若 allowed=false，直接提示用户充值。
2. **执行**：
   - 调用大模型生成内容，获取实际消耗 Token。
   - 业务方根据模型倍率算出 `final_price`。
3. **结算**：
   - 调用 consume (check_only=false, count=1, external_price=final_price)。


### 4.4 当前实现的一些重要行为（避免踩坑）

1) 未配置的 resource_key 会被拒绝

- 当 `user_quota_configs` 里找不到对应 `(plan_type, resource_key)` 时，直接返回 allowed=false

2) period 固定为 30 天滚动

- period 字段目前不会真的改变重置周期

3) 订阅过期会自动降级为 free

- 当前 `check_and_consume_quota` 会在订阅过期后按 free 套餐执行权益校验

4) 备注字段用于运营回溯

- `user_quota_configs.remark` 用于记录“这条权益配置为什么改”，建议管理端强制要求运营填写

## 5. 账单与运营分析（前端与运营最关心）

账单相关的三个概念：

- `payment_orders`：充值订单（发起支付与回调对接用）
- `wallet_transactions`：余额变动流水（余额 + / -）
- `user_bills`：面向运营与前端统计的统一账单视图（推荐以它为主做列表、筛选、图表）

### 5.1 运营通常需要看的维度（建议前端页面结构）

1) 全量账单列表（懒加载/分页）

- 目标：按时间倒序查看所有交易，支持搜索与筛选
- 筛选维度建议：时间范围、用户、类型（充值/扣费等）、状态、渠道、网关、订单号关键字
- 接口：`GET /api/user/admin/bills`

2) 全局统计（不和列表一起返回，避免一次性太重）

- 目标：看整体趋势与盘点
- 指标建议：总笔数、总金额、按类型/状态/渠道的聚合、按天的聚合
- 接口：`GET /api/user/admin/bills/stats`

3) 按用户汇总（运营看“谁花了多少钱/充了多少钱”）

- 目标：聚合到用户维度，支持分页查看 Top 用户
- 指标建议：账单笔数、总金额、充值金额、扣费金额、订阅金额、退款金额、最近一笔时间
- 接口：`GET /api/user/admin/bills/users/summary`

### 5.2 普通用户侧账单（用于个人对账）

- 接口：`GET /api/user/bills/my`（分页筛选）
- 统计：`GET /api/user/bills/my/stats`（按天/类型/状态/渠道聚合）

## 5. 你希望的“套餐订阅金额、折扣金额”等能力：推荐扩展方案

你提出的诉求本质上是两类配置：

- 权益配置：套餐 -> 资源 -> 限额/超额计费（目前已有）
- 定价配置：套餐 -> 订阅价格/折扣/促销（目前缺失）

建议把“定价”从 `user_quota_configs` 中拆出来，原因：

- 权益是按 resource_key 维度配置，定价是按 plan 维度配置，天然不是一个维度
- 同一套餐可能有多个价格策略（按月、按年、促销价、渠道价），强塞到 quota 表会让数据难维护

### 5.1 最小可行方案（不改数据库）：在 plans.json 增加价格字段

适合你想先跑通“前端展示价格 + 订阅下单 + 支付回调升级套餐”的闭环，但不急着做复杂促销后台的情况。

做法：

- 在 `services/user/plans.json` 给每个 plan 增加字段，例如：
  - `monthly_price_cny`
  - `yearly_price_cny`
  - `yearly_discount_cny` 或 `yearly_discount_rate`
  - `original_monthly_price_cny`（用于展示划线价）

优点：简单、改动小、无需迁移
缺点：不适合做多活动、多渠道、多币种

### 5.2 推荐长期方案（改数据库）：新增 subscription_plans 表 + 管理接口

新增一张“套餐定价表”（示例字段）：

- `plan_type`：free/pro/enterprise（唯一）
- `title`：展示名
- `billing_cycle`：monthly/yearly（如果你希望一个 plan 多条记录）
- `price_cny`：订阅金额
- `original_price_cny`：划线价（可选）
- `discount_amount_cny`：优惠金额（可选）
- `discount_rate`：折扣率（可选，二选一）
- `is_active`：是否生效

配套新增订阅购买流程（接口层面建议）：

1) `GET /api/user/subscription/plans`

- 前端展示套餐价格、折扣信息

2) `POST /api/user/subscription/orders`

- 创建订阅订单（本地记录订单 + 调用支付接口）
- 订单里记录：plan_type、billing_cycle、价格快照（很关键，避免改价影响历史订单）

3) 支付回调成功后：

- 更新 `user_subscriptions`：plan_type、expires_at（按 billing_cycle 叠加）
- 可选：重置或迁移 `user_usages`（例如新套餐生效后，是否立即按新额度重算）

### 5.3 “折扣金额/折扣码/促销”活动如何落地

如果你需要更灵活的促销，建议引入“价格快照 + 优惠规则”两层：

- 价格快照：订单创建时把最终应付金额写死（避免后续改配置导致对账困难）
- 优惠规则：订单创建时计算出来（例如折扣码、首月优惠、年付折扣等）

典型规则示例：

- 年付折扣：`yearly_price = monthly_price * 12 - discount_amount`
- 新用户首月优惠：仅当用户注册时间 < 7 天且未购买过订阅时生效

## 6. 一个完整的端到端示例（建议你按这个接入）

目标：限制“导出 PDF”每月 10 次，超额每次 2 元，专业版每月 100 次。

1) 管理端配置权益

- free:
  - `resource_key=pdf_export`
  - `limit_value=10`
  - `allow_overage=true`
  - `overage_unit_price=2`
- pro:
  - `resource_key=pdf_export`
  - `limit_value=100`
  - `allow_overage=true`
  - `overage_unit_price=1`

2) 业务服务端在导出前调用：

```json
{
  "user_id": "当前用户ID",
  "resource_key": "pdf_export",
  "count": 1
}
```

3) 若 allowed=true：继续导出并返回文件
4) 若 allowed=false 且 message 为余额不足：前端提示去充值
5) 前端通过 `GET /api/user/usage/my` 刷新展示本月已用次数
