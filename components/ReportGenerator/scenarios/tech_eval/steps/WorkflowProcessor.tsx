
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { streamGenerate, parseLlmJson } from '../../../../../api/stratify';
import { extractThoughtAndJson } from '../../../utils';
import { BrainIcon, SparklesIcon } from '../../../../icons';

declare global {
  interface Window {
    marked?: { parse(md: string): string; };
  }
}

const TARGET_MODEL = "openrouter@mistralai/devstral-2512:free";

const extractPartialValue = (text: string, keys: string[]): string => {
    for (const key of keys) {
        const regex = new RegExp(`"${key}"\\s*:\\s*"(?<content>(?:[^"\\\\]|\\\\.)*)`, 'gs');
        const matches = Array.from(text.matchAll(regex));
        if (matches.length > 0) {
            const lastMatch = matches[matches.length - 1];
            if (lastMatch.groups?.content) {
                return lastMatch.groups.content
                    .replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\t/g, '\t').replace(/\\$/, ''); 
            }
        }
    }
    return '';
};

export const WorkflowProcessor: React.FC<{
    taskId: string;
    scenario: string;
    initialSessionId: string;
    targetTech: string;
    materials: string;
    workflowState: string;
    setWorkflowState: (s: any) => void;
    markdownContent: string;
    setMarkdownContent: (md: string) => void;
    onConfirm: () => void;
}> = ({ taskId, scenario, initialSessionId, targetTech, materials, workflowState, setWorkflowState, markdownContent, setMarkdownContent, onConfirm }) => {
    const [currentStep, setCurrentStep] = useState<number>(1);
    const [thoughtStream, setThoughtStream] = useState('');
    const [sessionId, setSessionId] = useState(initialSessionId);
    const [parts, setParts] = useState({ p1: '', p2: '', p3: '', p4: '' });
    
    const scrollRef = useRef<HTMLDivElement>(null);
    const hasStarted = useRef(false);

    // 格式化 Step 4 的 JSON 为 Markdown 列表
    const formatReferences = (rawJson: string) => {
        try {
            const refs = JSON.parse(rawJson);
            if (Object.keys(refs).length === 0) return '';
            let md = '## 引用资料来源\n\n';
            Object.entries(refs).forEach(([title, url]) => {
                md += `- [${title}](${url})\n`;
            });
            return md;
        } catch (e) {
            // 如果不是合法JSON，直接返回原始文本（防止解析失败）
            return rawJson; 
        }
    };

    const combinedMarkdown = useMemo(() => {
        let md = `# 技术评估白皮书：${targetTech || '新技术分析'}\n\n`;
        md += `Generated by Agent 007  •  ${new Date().toLocaleDateString()}  •  **Draft v0.9**\n\n---\n\n`;
        if (parts.p1) md += `## 技术路线与当前所处阶段分析\n\n${parts.p1}\n\n`;
        if (parts.p2) md += `## 当前技术潜在风险识别与分析\n\n${parts.p2}\n\n`;
        if (parts.p3) md += `## 行业技术方案推荐\n\n${parts.p3}\n\n`;
        if (parts.p4) md += parts.p4; // p4 已经由 formatReferences 处理过
        return md.trim();
    }, [parts, targetTech]);

    useEffect(() => {
        setMarkdownContent(combinedMarkdown);
    }, [combinedMarkdown, setMarkdownContent]);

    useEffect(() => {
        if (workflowState === 'processing') {
            scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
        }
    }, [markdownContent, workflowState]);

    useEffect(() => {
        if (hasStarted.current) return;
        hasStarted.current = true;
        runPipeline();
    }, []);

    const executeStep = async (promptName: string, vars: any, logLabel: string, partKey?: keyof typeof parts): Promise<string> => {
        setThoughtStream(`我正在分析 ${logLabel}...`);
        return new Promise((resolve, reject) => {
            let accumulated = '';
            streamGenerate(
                { prompt_name: promptName, variables: vars, scenario, session_id: sessionId, model_override: TARGET_MODEL },
                (chunk) => {
                    accumulated += chunk;
                    if (partKey) {
                        const keys = partKey === 'p4' ? [] : [`第一部分_技术路线与当前所处阶段分析`, `第二部分_当前技术潜在风险识别与分析`, `第三部分_行业技术方案推荐`].filter(k => k.includes(partKey.replace('p','')));
                        
                        // 针对 p4 (引用资料) 的特殊逻辑
                        if (partKey === 'p4') {
                             const { jsonPart } = extractThoughtAndJson(accumulated);
                             if (jsonPart) setParts(prev => ({ ...prev, p4: formatReferences(jsonPart) }));
                        } else {
                            const content = extractPartialValue(accumulated, [`第一部分_技术路线与当前所处阶段分析`, `第二部分_当前技术潜在风险识别与分析`, `第三部分_行业技术方案推荐`]);
                            if (content) setParts(prev => ({ ...prev, [partKey]: content }));
                        }
                    }
                },
                () => resolve(accumulated),
                reject,
                (sid) => { if (sid) setSessionId(sid); },
                (tChunk) => setThoughtStream(prev => (prev.length > 80 ? tChunk : prev + tChunk))
            );
        });
    };

    const runPipeline = async () => {
        try {
            setCurrentStep(1);
            await executeStep('01_Role_ProtocolSetup', {}, '角色协议');
            setCurrentStep(2);
            await executeStep('02_DataIngestion', { reference_materials: materials }, '知识库对齐');
            setCurrentStep(3);
            await executeStep('03_TriggerGeneration_step1', { target_tech: targetTech }, '技术演进路线', 'p1');
            await executeStep('03_TriggerGeneration_step2', {}, '潜在风险识别', 'p2');
            await executeStep('03_TriggerGeneration_step3', {}, '方案推荐模型', 'p3');
            await executeStep('03_TriggerGeneration_step4', {}, '引用溯源', 'p4');
            setCurrentStep(4);
            setWorkflowState('done');
        } catch (e) { console.error(e); }
    };

    return (
        <div className="flex-1 flex flex-col h-full bg-white overflow-hidden relative">
            {/* Scroll Area */}
            <div ref={scrollRef} className="flex-1 overflow-y-auto custom-scrollbar p-10 bg-white">
                <article 
                    className="prose prose-slate max-w-none 
                    prose-h1:text-3xl prose-h1:font-black prose-h1:text-slate-900 prose-h1:mb-8
                    prose-h2:text-lg prose-h2:text-indigo-600 prose-h2:font-black prose-h2:uppercase prose-h2:tracking-wider prose-h2:mt-10
                    prose-p:text-slate-700 prose-p:leading-relaxed prose-p:text-sm
                    prose-li:text-sm prose-li:text-slate-600"
                    dangerouslySetInnerHTML={{ __html: window.marked?.parse(markdownContent) || '' }}
                />

                {/* Agent Thinking Card - Same Plane Layout */}
                {currentStep < 4 && (
                    <div className="mt-12 mb-20 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="bg-slate-50 rounded-3xl p-6 border border-slate-100 flex items-center gap-5">
                            <div className="relative">
                                <div className="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-100">
                                    <span className="font-bold text-sm">AI</span>
                                </div>
                                <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-50">
                                    <SparklesIcon className="w-3 h-3 text-indigo-500" />
                                </div>
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-center mb-1.5">
                                    <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest flex items-center gap-2">
                                        <div className="flex gap-1">
                                            <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce"></div>
                                            <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce delay-75"></div>
                                            <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce delay-150"></div>
                                        </div>
                                        Agent Thinking
                                    </span>
                                    <span className="text-[10px] font-mono text-slate-400">P: {Math.round((currentStep/4)*100)}%</span>
                                </div>
                                <p className="text-xs text-slate-500 font-medium truncate">{thoughtStream || '正在解析情报脉络...'}</p>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};
