import React, { useState, useEffect, useRef, useMemo } from 'react';
import { streamGenerate, parseLlmJson } from '../../../../../api/stratify';
import { extractThoughtAndJson } from '../../../utils';
// Added SparklesIcon to imports to fix "Cannot find name 'SparklesIcon'" error.
import { CheckIcon, BrainIcon, ChevronRightIcon, DocumentTextIcon, PencilIcon, ArrowRightIcon, SparklesIcon } from '../../../../icons';

declare global {
  interface Window {
    marked?: { parse(md: string): string; };
  }
}

const TARGET_MODEL = "openrouter@mistralai/devstral-2512:free";

const extractPartialValue = (text: string): string => {
    const matches = Array.from(text.matchAll(/"(?:第一部分_技术路线与当前所处阶段分析|第二部分_当前技术潜在风险识别与分析|第三部分_行业技术方案推荐|第四部分_引用资料来源)"\s*:\s*"(?<content>(?:[^"\\]|\\.)*)/gs));
    if (matches.length > 0) {
        const lastMatch = matches[matches.length - 1];
        if (lastMatch.groups?.content) {
            return lastMatch.groups.content
                .replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\t/g, '\t').replace(/\\$/, ''); 
        }
    }
    return '';
};

export const WorkflowProcessor: React.FC<{
    taskId: string;
    scenario: string;
    initialSessionId: string;
    targetTech: string;
    materials: string;
    workflowState: string;
    setWorkflowState: (s: any) => void;
    markdownContent: string;
    setMarkdownContent: (md: string) => void;
    onConfirm: () => void;
}> = ({ taskId, scenario, initialSessionId, targetTech, materials, workflowState, setWorkflowState, markdownContent, setMarkdownContent, onConfirm }) => {
    const [currentStep, setCurrentStep] = useState<number>(1);
    const [thoughtStream, setThoughtStream] = useState('');
    const [sessionId, setSessionId] = useState(initialSessionId);
    const [parts, setParts] = useState({ p1: '', p2: '', p3: '', p4: '' });
    const [isEditing, setIsEditing] = useState(false);

    const docEndRef = useRef<HTMLDivElement>(null);
    const hasStarted = useRef(false);

    const combinedMarkdown = useMemo(() => {
        let md = `# 多模态微出行机器人技术白皮书\n\n`;
        md += `Generated by Agent 007  •  Dec 18, 2025  •  **Draft v0.9**\n\n---\n\n`;
        if (parts.p1) md += `## 技术路线与当前所处阶段分析\n\n${parts.p1}\n\n`;
        if (parts.p2) md += `## 当前技术潜在风险识别与分析\n\n${parts.p2}\n\n`;
        if (parts.p3) md += `## 行业技术方案推荐\n\n${parts.p3}\n\n`;
        return md.trim();
    }, [parts]);

    useEffect(() => {
        setMarkdownContent(combinedMarkdown);
    }, [combinedMarkdown, setMarkdownContent]);

    useEffect(() => {
        if (workflowState === 'processing') docEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [markdownContent, workflowState]);

    useEffect(() => {
        if (hasStarted.current) return;
        hasStarted.current = true;
        runPipeline();
    }, []);

    const executeStep = async (promptName: string, vars: any, logLabel: string, partKey?: keyof typeof parts): Promise<string> => {
        setThoughtStream(`我正在分析 ${logLabel} 数据...`);
        return new Promise((resolve, reject) => {
            let accumulated = '';
            streamGenerate(
                { prompt_name: promptName, variables: vars, scenario, session_id: sessionId, model_override: TARGET_MODEL },
                (chunk) => {
                    accumulated += chunk;
                    if (partKey) {
                        const content = extractPartialValue(accumulated);
                        if (content) setParts(prev => ({ ...prev, [partKey]: content }));
                    }
                },
                () => resolve(accumulated),
                reject,
                (sid) => { if (sid) setSessionId(sid); },
                (tChunk) => setThoughtStream(prev => (prev.length > 100 ? tChunk : prev + tChunk))
            );
        });
    };

    const runPipeline = async () => {
        try {
            setCurrentStep(1);
            await executeStep('01_Role_ProtocolSetup', {}, '角色协议');
            setCurrentStep(2);
            await executeStep('02_DataIngestion', { reference_materials: materials }, 'SMA驱动材料特性表.csv');
            setCurrentStep(3);
            await executeStep('03_TriggerGeneration_step1', { target_tech: targetTech }, '技术路线章节', 'p1');
            await executeStep('03_TriggerGeneration_step2', {}, '潜在风险章节', 'p2');
            await executeStep('03_TriggerGeneration_step3', {}, '方案推荐章节', 'p3');
            setCurrentStep(4);
        } catch (e) { console.error(e); }
    };

    return (
        <div className="flex-1 flex flex-col h-full bg-[#f8fafc] overflow-hidden relative">
            
            {/* Step Indicators: 轻盈的顶部条 */}
            <div className="px-10 py-3 bg-white/80 backdrop-blur-md flex items-center gap-6 border-b border-slate-100 z-30">
                {['协议', '对齐', '生成', '复核'].map((label, i) => (
                    <div key={label} className="flex items-center gap-2">
                        <div className={`w-1.5 h-1.5 rounded-full ${currentStep >= i + 1 ? 'bg-indigo-600' : 'bg-slate-200'}`}></div>
                        <span className={`text-[11px] font-bold uppercase tracking-widest ${currentStep === i + 1 ? 'text-indigo-600' : 'text-slate-400'}`}>{label}</span>
                    </div>
                ))}
            </div>

            {/* Canvas Scroll Container */}
            <div className="flex-1 overflow-y-auto custom-scrollbar bg-[#f8fafc] relative">
                <div className="max-w-[850px] mx-auto py-16 px-10 md:px-20 min-h-full">
                    
                    {/* Paper Document Container */}
                    <div className="bg-white p-12 md:p-20 shadow-[0_10px_40px_rgba(0,0,0,0.03)] border border-slate-100 rounded-sm relative">
                        <div className="absolute top-0 left-0 w-full h-1 bg-indigo-500/10"></div>
                        
                        <article 
                            className="prose prose-slate max-w-none 
                            prose-h1:text-4xl prose-h1:font-black prose-h1:text-slate-900 prose-h1:mb-8
                            prose-h2:text-xl prose-h2:text-indigo-600 prose-h2:font-black prose-h2:uppercase prose-h2:tracking-wider prose-h2:mt-12
                            prose-p:text-slate-700 prose-p:leading-relaxed prose-p:text-[15px]
                            prose-strong:text-indigo-600"
                            dangerouslySetInnerHTML={{ __html: window.marked?.parse(markdownContent) || '' }}
                        />

                        {/* Spacer to prevent overlap by Thinking UI */}
                        <div ref={docEndRef} className="h-40" />
                    </div>
                </div>
            </div>

            {/* Agent Thinking Floating UI: 参考图中的底部卡片 */}
            <div className="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl px-6 z-40 animate-in slide-in-from-bottom-6">
                <div className="bg-white/95 backdrop-blur-xl rounded-[24px] border border-slate-200 shadow-[0_20px_50px_rgba(0,0,0,0.1)] p-5 ring-1 ring-black/5">
                    <div className="flex items-start gap-4">
                        {/* Profile/Status Icon */}
                        <div className="relative flex-shrink-0">
                            <div className="w-12 h-12 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                                <span className="font-bold text-sm">AI</span>
                            </div>
                            <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100">
                                <SparklesIcon className="w-3 h-3 text-indigo-500" />
                            </div>
                        </div>

                        {/* Text & Logic */}
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-center mb-1">
                                <div className="flex items-center gap-2">
                                    <div className="flex gap-1">
                                        <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce"></div>
                                        <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce delay-75"></div>
                                        <div className="w-1 h-1 bg-indigo-400 rounded-full animate-bounce delay-150"></div>
                                    </div>
                                    <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">Agent Thinking...</span>
                                </div>
                                <span className="text-[10px] font-mono text-slate-400">Process: {Math.min(95, currentStep * 25)}%</span>
                            </div>
                            
                            <p className="text-xs text-slate-600 leading-relaxed truncate-3-lines">
                                {thoughtStream || '正在等待数据输入信号...'}
                            </p>

                            {/* Contextual Actions */}
                            {currentStep >= 3 && (
                                <div className="mt-4 flex items-center gap-3">
                                    <button 
                                        onClick={onConfirm}
                                        className="px-4 py-2 bg-slate-900 text-white text-[10px] font-black rounded-lg hover:bg-indigo-600 transition-all active:scale-95 shadow-lg shadow-slate-200"
                                    >
                                        立即补充风险点
                                    </button>
                                    <button className="px-4 py-2 bg-slate-50 text-slate-400 text-[10px] font-bold rounded-lg border border-slate-100 hover:bg-slate-100">忽略</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};